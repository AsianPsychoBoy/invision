<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1, width=device-width, user-scalable=no"/>
  <meta name="format-detection" content="telephone=no,email=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <link rel="stylesheet" href="https://iissr.com//style/reset.css">
  <link rel="stylesheet" type="text/css" href="https://iissr.com/fonts/iconfont.css">
  <link rel="stylesheet" href="https://iissr.com/style/swiper.min.css">
  <link rel="stylesheet" href="https://iissr.com/style/home.css">
  <title>{{roomID}}客户端</title>
  
  <style>
  body{
	overflow-x: hidden;
  }
	audio{
        opacity: 0;
        display: none;
      }
    #msglog, #messageInput {
      border: 1px solid #ccc;
      width: 500px;
      height: 350px;
      overflow-y: auto;
      font-size: 14px;
    }
    #messageInput {
      height: 80px;
    }
    .message {
      line-height: 22px;
    }
    .message .user {
      padding-right: 5px;
      padding-left: 5px;
      color: brown;
    }
    .sysMsg {
      color: #c1bfbf;
      padding-right: 5px;
      padding-left: 5px;
      font-size: 12px;
    }
    #users {
      width: 100%;
      padding: 0 5px 5px;
    }
    .swiper-wrapper img{
	width:100%;
	}
	.swiper-container {
	width: 100%;
	}
	.swiper-slide {
	width: 100%;
	text-align: center;
	font-size: 18px;
	background: #fff;
	}
  </style>
</head>
<body>
	<div class="box" style="">
	  昵称: <span id="userName"></span> <br/>
	  房间: {{roomID}} <br/>
	  当前在线人数: <span id="count">{{users.length}}</span> <br/>
	  在线用户:  <div id="users">{{users}}</div>

	  <button id="joinOrLeave">退出房间</button>
	 
	  
		<div id="recordingslist"></div>
	</div>
    <div class="bannar">
        <div class="swiper-container">
            <div class="swiper-wrapper">
                <div class="swiper-slide" data-number="0"><img src="https://www.iissr.com/images/index.jpg" alt=""></div>
                <div class="swiper-slide" data-number="1"><img src="https://www.iissr.com/images/index.jpg" alt=""></div>
                <div class="swiper-slide" data-number="2"><img src="https://www.iissr.com/images/index.jpg" alt=""></div>
                <div class="swiper-slide" data-number="3"><img src="https://www.iissr.com/images/index.jpg" alt=""></div>
            </div>
            <!-- Add Pagination -->
            <div class="swiper-pagination"></div>
        </div>
    </div>
        <div class="center" style="padding-bottom: 80px">
          <div class="center-auto">
            <ul class="app-box" id="app-box">
              <!-- <li>
                  <div class="time-box">05-23 12:53</div>
                  <div class="yp-box clearfix">
                      <div class="left-box">
                          <div class="big-tx"><img src="./images/tx.jpg"></div>
                          <div class="s-yuan">赏</div>
                      </div>
                      <div class="right-box">
                          <div class="name clearfix"><div class="wlds">刘老师物理辅导</div><div class="zjr">主讲人</div></div>
                              <div class="bg-video">
                                <div class="videoPlayer videoContainer" id="videoContainer">
                                  <audio id="video1" class="video1" controls>
                                    <source src="song.mp3" type="audio/mpeg">
                                  </audio>
                                  <div id="videoControls" class="clearfix videoControls"> 
                                    <div class="right-video">
                                        <div id="playBtn" class="play playBtn" title="Play"> <i class="icon iconfont">&#xe603;</i> </div> 
                                    </div> 
              
                                    <div class="heng-box">
              
                                    <div id="progressWrap" class="progressWrap">  
                                      <div id="playProgress" class="playProgress"></div>
                                    </div>
              
                                    </div>
                                    
                                      <div class="time"></div>
                                  </div> 
                                </div>
                            </div>
                      </div>
                  </div>
              </li> -->

          </ul>
          </div>
        </div>
        


       <form class="subform" action="">
          <div class="form-auto clearfix">
            <div class="cz">操作</div> 
            <div class="input-box">
                <div class="text clearfix">
                <div class="in-box"><input type="text" id="m" placeholder="加入一起讨论..." /></div>
                  <div class="tw clearfix" id="tw" data-status="false">
                    <div class="yuan yuan-bor">
                      <div class="x-yuan"></div>
                    </div>
                    <div class="tw-text">提问</div>
                  </div>
                </div>
            </div>
            <button class="submit" id="submit">发送</button>
          </div>
        </form>

        <ul id="messages">
            <!-- <li>
                <div class="tx-box"><img src="./images/tx.jpg"></div>
                <div class="litext"><div class="bghei clearfix"><span>哈哈哈哈哈和黑河喝就家加就</span></div></div>
            </li>
            <li>
                <div class="tx-box"><img src="./images/tx.jpg"></div>
                <div class="litext"><div class="bghei clearfix"><span>哈哈哈哈哈和黑河喝就家加就</span></div></div>
            </li>
            <li>
                <div class="tx-box"><img src="./images/tx.jpg"></div>
                <div class="litext"><div class="bghei clearfix"><span>哈哈哈哈哈和黑河喝就家加就</span></div></div>
            </li> -->
        </ul>

  <script src="https://iissr.com/socket.io/socket.io.js"></script>
  <script src="https://cdn.bootcss.com/store.js/1.3.20/store.js"></script>
  <script src="https://iissr.com/js/jquery.js"></script>
  <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
  <script src="https://iissr.com/js/sha1.js"></script>
  <script src="https://iissr.com/js/swiper.min.js"></script>
  <script src="https://iissr.com/js/fastclick.min.js"></script>
  <script src="https://iissr.com/js/niceClick.js"></script>
  <script src="https://iissr.com/js/wxconfig.js"></script>
  <!--<script src="http://iissr.com/js/scoket.js"></script>-->
  <script>
    $(function () {
      // ----------设置昵称-------------
	  
	  	var swiper = new Swiper('.swiper-container', {
            pagination: '.swiper-pagination',
            loop:true,//无限循环
            paginationClickable: true,
            // spaceBetween: 30, 样式的中间间隔
            centeredSlides: true,
            //autoplay: 2000,//自动播放的时间间隔
            autoplayDisableOnInteraction: false
        });
	  
	  var user = store.get('user');
	  console.log("user",user);
	  
	  if(user !== undefined){
		var userName = user.nickname;
		var userImg = user.headimgurl;
	  }

	  $('#userName').text(userName);
      /*while ($('#userName').text().trim() === '') {
        userName = prompt("请设置你的昵称","");
        $('#userName').text(userName);
      }*/


      // ---------创建连接-----------
      var socket = io();

      // 加入房间
      socket.on('connect', function () {
        socket.emit('join', userName);
      });

      // 监听消息
      socket.on('msg', function (userName, msg) {
        /*var message = '' +
            '<div class="message">' +
            '  <span class="user">' + userName + ': </span>' +
            '  <span class="msg">' + msg + '</span>' +
            '</div>';
        $('#msglog').append(message);
        // 滚动条保持最下方
        $('#msglog').scrollTop($('#msglog')[0].scrollHeight);*/
		
		
		console.log("msg=============",msg);
		
		
	    if(msg.type == 0 ){
			appBoxDom(msg);
		}else if(msg.type == 1){
			appJsText(msg);
		}else{
	     $('#messages').append(function() {
			  var liNum = $('#messages li').length;
			  if(liNum > 2){
				$("#messages li:first").remove();
			  };
			  var liDom = '<li>' +
				'<div class="tx-box"><img src="'+msg.userImg+'"></div>' +
				'<div class="litext"><div class="bghei clearfix"><span>' + msg.text + '</span></div></div>' +
				'</li>';
			  return liDom;
        });	
		}		
      });
	  
	  
	  	     var i = 1;
             var appBoxDom = function(key){		
                  var videoDom = '<li>' +
                    '<div class="time-box">'+key.time+'</div>' +
                    '<div class="yp-box clearfix">' +
                    '<div class="left-box">' +
                    '<div class="big-tx"><img src="'+key.userImg+'"></div>' +
                    '<div class="s-yuan">赏</div>' +
                    '</div>' +
                    '<div class="right-box">' +
                    '<div class="name clearfix"><div class="wlds">'+key.username+'</div><div class="zjr">主讲人</div></div>' +
                    '<div class="bg-video">' +
                    '<div class="videoPlayer videoContainer" id="videoContainer'+i+'">' +
                    '<audio id="video'+i+'" class="video1" controls onended="onendedFun(this)">' +
                    '<source src="'+key.url+'" type="audio/mpeg">' +
                    '</audio>' +
                    '<div id="videoControls'+i+'" class="clearfix videoControls">' +
                    '<div class="right-video">' +
                    '<div id="playBtn'+i+'" class="play playBtn" title="Play"> <i class="icon iconfont">&#xe603;</i> </div>' +
                    '</div>' +
                    '<div class="heng-box">' +
                    '<div id="progressWrap'+i+'" class="progressWrap">' +
                    '<div id="playProgress'+i+'" class="playProgress"></div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="time"></div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</li>';
                    $("#app-box").append(videoDom);
					swiper.slideTo(key.imgNum, 1000, false);//切换到第一个slide，速度为1秒
                    i++;
              }
	  	   
	  
			var appJsText = function(key){
				   var liText = '<li>'+
						'<div class="time-box">'+key.time+'</div>'+
						'<div class="yp-box clearfix">'+
							'<div class="left-box">'+
								'<div class="big-tx">'+
									 '<img src="'+key.userImg+'">'+
								'</div>'+
							'</div>'+
							'<div class="right-box">'+
								'<div class="name clearfix">'+
								'<div class="wlds">'+key.username+'</div>'+
								'<div class="zjr">主讲人</div>'+
								'</div>'+
								'<div class="jstext">'+key.msg+'</div>'+
							'</div>'+
						'</div>'+
						'</li>';
				$("#app-box").append(liText);	
			} 
	  
	  
			$("#app-box").on("click",".playBtn",function(){
                  var _this = $(this);
                  var videoContainer = _this.parents(".videoContainer");
                  var playBtn = $("#"+ _this.attr("id"))[0];
                  var video = $("#"+videoContainer.find(".video1").attr('id'))[0];
                  var playProgress = $("#"+videoContainer.find(".playProgress").attr('id'))[0];
                  var progressWrap = $("#"+videoContainer.find(".progressWrap").attr('id'))[0];
                  play(video,playBtn,playProgress,progressWrap);
                })

                function play(v,p,pps,pw){

                if ( v.paused || v.ended ){              
                    if ( v.ended ){ 
                        v.currentTime = 0;
                        } 
                    v.play();
                    p.innerHTML = '<i class="icon iconfont">&#xe61e;</i>';  //暂停
                    progressFlag = setInterval(function(){
                      var percent = v.currentTime / v.duration;
                      pps.style.width = percent * (pw.offsetWidth) - 2 + "px";
                      if(percent == 1){
                        clearInterval(progressFlag)  //播放完成 销毁
                      }
                    }, 60);
                } 
                else{ 
                    v.pause(); 
                    p.innerHTML = '<i class="icon iconfont">&#xe603;</i>'; //播放
                    clearInterval(progressFlag);
                } 
            }
              //监听视频是否播放完成
             function onendedFun(dom){
              console.log(dom);
               var playBtn = $("#"+$(dom).parents(".videoContainer").find(".playBtn").attr('id'))[0];
               var playProgress = $("#"+$(dom).parents(".videoContainer").find(".playProgress").attr('id'))[0];
               var progressWrap = $("#"+$(dom).parents(".videoContainer").find(".progressWrap").attr('id'))[0];
              console.log(playBtn)

                  if(dom.ended == true){
                    playBtn.innerHTML = '<i class="icon iconfont">&#xe603;</i>'; //播放
                      playProgress.style.width = 0;
                    console.log("视频播放完成");
                  }
                }
	  
	  
	  

      // 监听系统消息
      socket.on('sys', function (sysMsg, users) {
        var message = '<div class="sysMsg">' + sysMsg + '</div>';
        $('#msglog').append(message);

        $('#count').text(users.length);
        $('#users').text(users);
      });
	
	  var inputId = $("#m");
      // 发送消息
      $('#submit').click(function (e) {
		  var msg = {};
          e.preventDefault();
          var text = inputId.val();
		  msg.text =  text;
		  msg.usename = userName;
		  msg.userImg = userImg;
          socket.send(msg);
		  inputId.val('');
      });

      // 退出房间
      $('#joinOrLeave').click(function () {
        if ($(this).text() === '退出房间') {
          $(this).text('进入房间');
          socket.emit('leave');
          var msg = '你已经退出了房间,重新发言请点击"进入房间"';
          $('#msglog').append('<div class="sysMsg">'+msg+'</div>');
        } else {
          $(this).text('退出房间');
          socket.emit('join', userName);
        }

      });
    });
  </script>
</body>
</html>